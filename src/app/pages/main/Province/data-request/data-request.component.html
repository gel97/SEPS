<div class="container-fluid mt-3">
  <div class="card o-hidden border-2 shadow-sm my-5">
    <div class="card-body p-3">
      <div class="row">
        <!-- LEFT PANEL -->
        <div class="col-md-4">
          <h5 class="text-primary">Municipality/City</h5>

          <ul class="list-group" style="max-height: 70vh; overflow-y: auto">
            <li
              class="list-group-item"
              *ngFor="let item of listData"
              [class.active]="selectedMunCityId === item.munCityId"
              (click)="selectMunicipality(item)"
            >
              {{ item.munCityName }}
            </li>
          </ul>
        </div>

        <!-- RIGHT PANEL -->
        <div class="col-md-8">
          <h5 class="text-primary">
            {{ selectedMunCityName || "Select a Municipality" }}
          </h5>

          <!-- Add Request Button -->
          <div *ngIf="selectedMunCityId" class="mb-3">
            <button
              type="button"
              class="btn btn-primary"
              data-toggle="modal"
              data-target="#ModalAdd"
            >
              âž• Request Data
            </button>
          </div>

          <!-- Requests Table -->

          <div *ngFor="let yearGroup of list_sep_year" class="mb-4">
            <!-- Year + Core Element Header -->
            <div
              class="bg-primary text-white px-3 py-2 rounded-top fw-bold shadow-sm"
              *ngIf="selectedMunCityName"
            >
              ðŸ“… {{ yearGroup.setYear }} â€” {{ yearGroup.coreElement?.name }}
            </div>

            <!-- Requests Table -->
            <div
              class="table-responsive shadow-sm rounded-bottom"
              *ngIf="selectedMunCityName"
            >
              <table class="table table-hover table-striped align-middle mb-0">
                <thead class="table-light">
                  <tr>
                    <th scope="col">ðŸ“Œ Title</th>
                    <th scope="col">ðŸ“„ Template</th>
                    <th scope="col" class="text-center">âš¡ Actions</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let req of yearGroup.requests">
                    <td class="fw-semibold">{{ req.details }}</td>
                    <td>
                      <em>{{ req.templates?.name || "â€”" }}</em>
                    </td>
                    <td class="text-center">
                      <button
                        class="btn btn-sm btn-outline-danger me-1"
                        title="Delete"
                      >
                        ðŸ—‘
                      </button>
                      <button
                        class="btn btn-sm btn-outline-primary"
                        title="Open Link"
                      >
                        ðŸ”—
                      </button>
                    </td>
                  </tr>
                  <tr *ngIf="yearGroup.requests.length === 0">
                    <td colspan="3" class="text-center text-muted py-3">
                      No requests available for this group.
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>

          <div *ngIf="selectedRequests.length === 0 && selectedMunCityId">
            <p class="text-muted">No requests found for this municipality.</p>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- MODAL -->
<div
  class="modal fade bd-example-modal-lg"
  id="ModalAdd"
  tabindex="-1"
  role="dialog"
  aria-labelledby="exampleModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content">
      <form #templateForm="ngForm">
        <div class="modal-header">
          <h5 class="modal-title" id="exampleModalLabel">Request</h5>
          <button
            type="button"
            #closebutton
            class="close"
            data-dismiss="modal"
            aria-label="Close"
          >
            <span aria-hidden="true">&times;</span>
          </button>
        </div>

        <div class="modal-body">
          <div class="row g-3">
            <!-- Year Dropdown -->
            <div class="col-lg-12">
              <label for="setYear">Year:</label>
              <select
                class="form-control"
                required
                [(ngModel)]="set_year"
                name="setYear"
              >
                <option
                  *ngFor="let item of list_sep_year"
                  [value]="item.setYear"
                >
                  {{ item.setYear }}
                </option>
              </select>
            </div>

            <!-- Title -->
            <div class="col-lg-12">
              <label for="title">Title:</label>
              <input
                type="text"
                class="form-control"
                required
                [(ngModel)]="newRequest.title"
                name="title"
              />
            </div>

            <!-- Details -->
            <div class="col-lg-12">
              <label for="details">Details:</label>
              <input
                type="text"
                class="form-control"
                required
                [(ngModel)]="newRequest.details"
                name="details"
              />
            </div>

            <!-- Search Templates -->
            <div class="col-lg-12">
              <label for="templateSearch">Search Template:</label>
              <input
                type="text"
                class="form-control"
                [value]="templateSearchText"
                [(ngModel)]="templateSearchText"
                (input)="onTemplateSearchChange($event)"
                placeholder="Search by template or core element"
                name="templateSearch"
              />

              <div *ngIf="templateSearchText">
                <ng-container
                  *ngIf="
                    filteredTemplatesByGroup &&
                      (filteredTemplatesByGroup | keyvalue).length > 0;
                    else noMatchFound
                  "
                >
                  <div
                    *ngFor="let group of filteredTemplatesByGroup | keyvalue"
                    class="mt-3"
                  >
                    <h5 class="text-primary">{{ group.key }}</h5>
                    <ul class="list-group">
                      <li
                        class="list-group-item"
                        *ngFor="let template of group.value"
                        (click)="selectTemplate(template)"
                        style="cursor: pointer"
                      >
                        <strong>{{ template.name }}</strong
                        ><br />
                        <small
                          >Core Element: {{ template.coreElementName }}</small
                        >
                      </li>
                    </ul>
                  </div>
                </ng-container>

                <ng-template #noMatchFound>
                  <div class="text-danger mt-2">
                    No matching template found.
                  </div>
                </ng-template>
              </div>
            </div>
          </div>
        </div>

        <!-- Footer -->
        <div class="modal-footer">
          <button
            type="button"
            class="btn btn-primary"
            (click)="saveDataRequest()"
          >
            <i class="fa fa-check"></i> Add
          </button>
        </div>
      </form>
    </div>
  </div>
</div>
